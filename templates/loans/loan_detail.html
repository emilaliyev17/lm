{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<h2>Loan Card: {{ loan.card_number }}</h2>
<p style="color: #666; margin-bottom: 2rem;">Borrower: {{ loan.borrower.name }}</p>

<div style="margin-bottom: 1.5rem;">
    <a href="{% url 'edit_loan_details' loan.card_number %}" class="btn btn-primary">Edit Loan Details</a>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Loan Amounts</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div>
                <strong>Advanced Loan:</strong> ${{ loan.advanced_loan_amount|floatformat:2|intcomma }}<br>
                <strong>Invoice #:</strong> {% if loan.advanced_loan_invoice %}{{ loan.advanced_loan_invoice }}{% else %}—{% endif %}<br>
                <strong>First Wired:</strong> ${{ loan.first_wired_amount|floatformat:2|intcomma }}<br>
                <strong>Interest Rate:</strong> {{ interest_rate_percent }}%
            </div>
            <div>
                <strong>Settlement Charges:</strong> ${{ loan.total_settlement_charges|floatformat:2|intcomma }}<br>
                <strong>Total Funded:</strong> ${{ total_funded|floatformat:2|intcomma }}<br>
                <strong>Funded Date:</strong> {{ loan.first_loan_date|date:"n/j/y" }}<br>
                <strong>Maturity Date:</strong> {% if loan.maturity_date %}{{ loan.maturity_date|date:"n/j/y" }}{% else %}—{% endif %}
            </div>
        </div>
    </div>
    
    <div class="detail-card">
        <h3>Checkpoint Validation</h3>
        <div class="formula">
            ${{ loan.first_wired_amount }} + ${{ loan.total_settlement_charges }} - ${{ loan.advanced_loan_amount }} = 
            {% if checkpoint_valid %}
                <span class="checkpoint-valid">${{ checkpoint|floatformat:2|intcomma }} ✓</span>
            {% else %}
                <span class="checkpoint-invalid">${{ checkpoint|floatformat:2|intcomma }} ✗</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Settlement Charges 
            <a href="{% url 'edit_loan_invoices' loan.card_number %}" class="btn">Edit</a>
        </h3>
        <table>
            <tr>
                <th>Charge</th>
                <th>Invoice #</th>
                <th style="text-align: right;">Amount</th>
            </tr>
            {% for charge in settlement_charges %}
            <tr>
                <td>{{ charge.charge_type.name }}</td>
                <td>{% if charge.invoice_number %}{{ charge.invoice_number }}{% else %}—{% endif %}</td>
                <td style="text-align: right;">${{ charge.amount|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <div class="detail-card">
        <h3>Prepaid Interest Status</h3>
        {% if prepaid_interest %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                <div>
                    <strong>Initial Amount:</strong> ${{ prepaid_interest.initial_amount|floatformat:2|intcomma }}<br>
                    <strong>Monthly Amount:</strong> ${{ prepaid_interest.monthly_amount|floatformat:2|intcomma }}
                </div>
                <div>
                    <strong>Remaining Balance:</strong>
                    <span {% if prepaid_interest.low_balance %}style="color: #e67e22; font-weight: bold;"{% endif %}>
                        ${{ prepaid_interest.remaining_balance|floatformat:2|intcomma }}
                    </span><br>
                    <strong>Months Covered:</strong> {{ prepaid_interest.months_covered }}
                </div>
            </div>
            <div style="margin-top: 0.75rem;">
                <strong>Months Remaining:</strong>
                <span {% if prepaid_interest.low_balance %}style="color: #e67e22; font-weight: bold;"{% endif %}>
                    {{ prepaid_interest.months_remaining }}
                </span>
                {% if prepaid_interest.low_balance %}
                    <span style="display: inline-block; margin-left: 0.5rem; padding: 0.15rem 0.5rem; background: rgba(230, 126, 34, 0.15); border-radius: 4px; color: #e67e22;">
                        Warning: Less than two months remaining
                    </span>
                {% endif %}
            </div>
        {% else %}
            <p style="color: #999;">No prepaid interest</p>
        {% endif %}
    </div>
    <div class="detail-card">
        <h3>Funding Information</h3>
        <table>
            <tr>
                <td><strong>Draw #0 (Advanced Loan)</strong></td>
                <td style="text-align: right;">${{ loan.advanced_loan_amount|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">{{ loan.first_loan_date|date:"n/j/y" }}</td>
                <td style="text-align: right;">{{ interest_rate_percent }}%</td>
            </tr>
            {% for draw in loan.additional_draws.all %}
            <tr>
                <td><strong>Draw #{{ draw.draw_number|add:"-1" }}</strong></td>
                <td style="text-align: right;">${{ draw.amount|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">{{ draw.draw_date|date:"n/j/y" }}</td>
                <td style="text-align: right;">{% widthratio draw.interest_rate 1 100 %}%</td>
            </tr>
            {% endfor %}
            <tr style="border-top: 2px solid #ddd; font-weight: bold;">
                <td>Total Funded</td>
                <td style="text-align: right;">${{ total_funded|floatformat:2|intcomma }}</td>
                <td colspan="2"></td>
            </tr>
        </table>
    </div>
</div>

<!-- Loan Extensions -->
{% if loan.extensions.exists %}
<div class="detail-card" style="margin-top: 2rem;">
    <h3>Loan Extensions</h3>
    <table>
        <tr>
            <th>Extension</th>
            <th>Period</th>
            <th>Fee</th>
            <th>Reason</th>
            <th>Date Added</th>
        </tr>
        {% for extension in loan.extensions.all %}
        <tr>
            <td>Extension #{{ forloop.counter }}</td>
            <td>{{ extension.extension_months }} months</td>
            <td>${{ extension.extension_fee|floatformat:2|intcomma }}</td>
            <td>{{ extension.reason|default:'—' }}</td>
            <td>{{ extension.created_date|date:"n/j/y" }}</td>
        </tr>
        {% endfor %}
        <tr style="font-weight: bold; border-top: 2px solid #ddd;">
            <td colspan="2">Total Extension Fees</td>
            <td>${{ loan.get_total_extension_fees|floatformat:2|intcomma }}</td>
            <td colspan="2"></td>
        </tr>
    </table>
</div>
{% endif %}

<!-- Interest Schedule Section -->
<div class="detail-card" style="margin-top: 2rem;">
    <h3>Interest Payment Schedule</h3>
    <div style="margin-bottom: 1rem;">
        <p>Monthly interest payments and invoicing</p>
        <table style="width: 100%;">
            <tr>
                <td><strong>Total Periods:</strong></td>
                <td>{{ loan.interest_schedules.count }}</td>
                <td><strong>Posted:</strong></td>
                <td>
                    {% regroup loan.interest_schedules.all by is_posted as posted_groups %}
                    {% for group in posted_groups %}
                        {% if group.grouper %}{{ group.list|length }}{% endif %}
                    {% endfor %}
                </td>
            </tr>
            <tr>
                <td><strong>Monthly Interest:</strong></td>
                <td>${{ loan.get_monthly_interest_for_initial|floatformat:2|intcomma }}</td>
                <td><strong>Pending:</strong></td>
                <td>
                    {% regroup loan.interest_schedules.all by is_posted as posted_groups %}
                    {% for group in posted_groups %}
                        {% if not group.grouper %}{{ group.list|length }}{% endif %}
                    {% endfor %}
                </td>
            </tr>
        </table>
    </div>
    <a href="{% url 'interest_schedule' loan.card_number %}" class="btn btn-info">
        View Full Schedule →
    </a>
</div>

<div style="margin-top: 2rem;">
    <a href="{% url 'add_draw' loan.card_number %}" class="btn btn-success" style="margin-right: 1rem;">+ Add Draw</a>
    <a href="{% url 'add_extension' loan.card_number %}" class="btn btn-warning" style="margin-left: 0.5rem;">+ Add Extension</a>
    <a href="/api/loans/" class="btn">← Back to List</a>
</div>

<div class="detail-card" style="margin-top: 2rem;">
    <h3>Loan Status</h3>
    <form method="post" action="{% url 'change_loan_status' loan.card_number %}" onsubmit="return confirm('Are you sure you want to update the loan status?');">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: center;">
            <div>
                <strong>Current Status:</strong>
                <span class="status-{{ effective_status_code }}" style="margin-left: 0.5rem;">{{ effective_status_display }}</span>
            </div>
            <div>
                <label for="status-select"><strong>Change to:</strong></label>
                <select id="status-select" name="dynamic_status" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    {% for status in available_statuses %}
                        <option value="{{ status.code }}" {% if effective_status_code == status.code|lower %}selected{% endif %}>{{ status.code }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Update Status</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}
