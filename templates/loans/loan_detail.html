{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<h2>Loan Card: {{ loan.card_number }}</h2>
<p style="color: #666; margin-bottom: 2rem;">Borrower: {{ loan.borrower.name }}</p>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Loan Amounts</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div>
                <strong>Advanced Loan:</strong> ${{ loan.advanced_loan_amount|floatformat:2|intcomma }}<br>
                <strong>First Wired:</strong> ${{ loan.first_wired_amount|floatformat:2|intcomma }}<br>
                <strong>Interest Rate:</strong> {{ interest_rate_display|floatformat:1 }}%
            </div>
            <div>
                <strong>Settlement Charges:</strong> ${{ loan.total_settlement_charges|floatformat:2|intcomma }}<br>
                <strong>Total Funded:</strong> ${{ total_funded|floatformat:2|intcomma }}<br>
                <strong>Funded Date:</strong> {{ loan.first_loan_date|date:"n/j/y" }}
            </div>
        </div>
    </div>
    
    <div class="detail-card">
        <h3>Checkpoint Validation</h3>
        <div class="formula">
            ${{ loan.first_wired_amount }} + ${{ loan.total_settlement_charges }} - ${{ loan.advanced_loan_amount }} = 
            {% if checkpoint_valid %}
                <span class="checkpoint-valid">${{ checkpoint|floatformat:2|intcomma }} ✓</span>
            {% else %}
                <span class="checkpoint-invalid">${{ checkpoint|floatformat:2|intcomma }} ✗</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Settlement Charges</h3>
        <table>
            {% for charge in settlement_charges %}
            <tr>
                <td>{{ charge.charge_type.name }}</td>
                <td style="text-align: right;">${{ charge.amount|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <div class="detail-card">
        <h3>Funding Information</h3>
        <table>
            <tr>
                <td><strong>Draw #0 (Advanced Loan)</strong></td>
                <td style="text-align: right;">${{ loan.advanced_loan_amount|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">{{ loan.first_loan_date|date:"n/j/y" }}</td>
                <td style="text-align: right;">{% widthratio loan.initial_interest_rate 1 100 %}%</td>
            </tr>
            {% for draw in loan.additional_draws.all %}
            <tr>
                <td><strong>Draw #{{ draw.draw_number|add:"-1" }}</strong></td>
                <td style="text-align: right;">${{ draw.amount|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">{{ draw.draw_date|date:"n/j/y" }}</td>
                <td style="text-align: right;">{% widthratio draw.interest_rate 1 100 %}%</td>
            </tr>
            {% endfor %}
            <tr style="border-top: 2px solid #ddd; font-weight: bold;">
                <td>Total Funded</td>
                <td style="text-align: right;">${{ total_funded|floatformat:2|intcomma }}</td>
                <td colspan="2"></td>
            </tr>
        </table>
    </div>
</div>

<!-- Loan Extensions -->
{% if loan.extensions.exists %}
<div class="detail-card" style="margin-top: 2rem;">
    <h3>Loan Extensions</h3>
    <table>
        <tr>
            <th>Extension</th>
            <th>Period</th>
            <th>Fee</th>
            <th>Interest</th>
            <th>Date Added</th>
        </tr>
        {% for extension in loan.extensions.all %}
        <tr>
            <td>Extension #{{ forloop.counter }}</td>
            <td>{{ extension.extension_months }} months</td>
            <td>${{ extension.extension_fee|floatformat:2|intcomma }}</td>
            <td>{% if extension.has_interest %}{% widthratio extension.interest_rate 1 100 %}%{% else %}No{% endif %}</td>
            <td>{{ extension.created_date|date:"n/j/y" }}</td>
        </tr>
        {% endfor %}
        <tr style="font-weight: bold; border-top: 2px solid #ddd;">
            <td colspan="2">Total Extension Fees</td>
            <td>${{ loan.get_total_extension_fees|floatformat:2|intcomma }}</td>
            <td colspan="2"></td>
        </tr>
    </table>
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="{% url 'add_draw' loan.card_number %}" class="btn btn-success" style="margin-right: 1rem;">+ Add Draw</a>
    <a href="{% url 'add_extension' loan.card_number %}" class="btn btn-warning" style="margin-left: 0.5rem;">+ Add Extension</a>
    <a href="/api/loans/" class="btn">← Back to List</a>
</div>
{% endblock %}
