{% extends 'base.html' %}
{% block content %}
<h2>Loan Card: {{ loan.card_number }}</h2>
<p style="color: #666; margin-bottom: 2rem;">Borrower: {{ loan.borrower.name }}</p>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Loan Amounts</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div>
                <strong>Advanced Loan:</strong> ${{ loan.advanced_loan_amount|floatformat:2 }}<br>
                <strong>First Wired:</strong> ${{ loan.first_wired_amount|floatformat:2 }}<br>
                <strong>Interest Rate:</strong> {{ interest_rate_display|floatformat:1 }}%
            </div>
            <div>
                <strong>Settlement Charges:</strong> ${{ loan.total_settlement_charges|floatformat:2 }}<br>
                <strong>Total Funded:</strong> ${{ total_funded|floatformat:2 }}<br>
                <strong>Funded Date:</strong> {{ loan.first_loan_date|date:"M d, Y" }}
            </div>
        </div>
    </div>
    
    <div class="detail-card">
        <h3>Checkpoint Validation</h3>
        <div class="formula">
            J14 + J22 - J13 = J23<br>
            ${{ loan.first_wired_amount }} + ${{ loan.total_settlement_charges }} - ${{ loan.advanced_loan_amount }} = 
            {% if checkpoint_valid %}
                <span class="checkpoint-valid">${{ checkpoint|floatformat:2 }} ✓</span>
            {% else %}
                <span class="checkpoint-invalid">${{ checkpoint|floatformat:2 }} ✗</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Settlement Charges</h3>
        <table>
            {% for charge in settlement_charges %}
            <tr>
                <td>{{ charge.charge_type.name }}</td>
                <td style="text-align: right;">${{ charge.amount|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <div class="detail-card">
        <h3>Funding Information</h3>
        <table>
            <tr>
                <td><strong>Draw #0 (Advanced Loan)</strong></td>
                <td style="text-align: right;">${{ loan.advanced_loan_amount|floatformat:2 }}</td>
                <td style="text-align: right;">{{ loan.first_loan_date|date:"M d, Y" }}</td>
            </tr>
            {% for draw in loan.additional_draws.all %}
            <tr>
                <td><strong>Draw #{{ draw.draw_number|add:-1 }}</strong></td>
                <td style="text-align: right;">${{ draw.amount|floatformat:2 }}</td>
                <td style="text-align: right;">{{ draw.draw_date|date:"M d, Y" }}</td>
            </tr>
            {% endfor %}
            <tr style="border-top: 2px solid #ddd; font-weight: bold;">
                <td>Total Funded</td>
                <td style="text-align: right;">${{ total_funded|floatformat:2 }}</td>
                <td></td>
            </tr>
        </table>
    </div>
</div>

<div style="margin-top: 2rem;">
    <a href="{% url 'add_draw' loan.card_number %}" class="btn btn-success" style="margin-right: 1rem;">+ Add Draw</a>
    <a href="/api/loans/" class="btn">← Back to List</a>
</div>
{% endblock %}
