{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="margin: 0;">Loan Dashboard</h2>
    <a href="{% url 'create_loan' %}" class="btn btn-primary">+ New Loan Card</a>
</div>

<!-- Universal Search -->
<div class="search-container" style="margin-bottom: 2rem; position: relative;">
    <input type="text" 
           id="loan-search" 
           class="search-input"
           placeholder="Search by card number, borrower, or invoice number..."
           autocomplete="off"
           style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem;">
    <div id="search-results" class="search-dropdown" style="display: none;">
        <!-- Results populated by JavaScript -->
    </div>
    <div id="search-loading" style="display: none; position: absolute; right: 1rem; top: 0.75rem;">
        <span style="color: #3498db;">Searching...</span>
    </div>
</div>

<div class="stats">
    <div class="stat-card">
        <div class="stat-value">{{ total_loans }}</div>
        <div class="stat-label">Total Loans</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ active_loans }}</div>
        <div class="stat-label">Active Loans</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">${{ total_portfolio|floatformat:0|intcomma|default:"0" }}</div>
        <div class="stat-label">Total Portfolio</div>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Card Number</th>
            <th>Borrower</th>
            <th>Advanced Loan</th>
            <th>First Wired</th>
            <th>Invoice #</th>
            <th>Rate</th>
            <th>Settlement</th>
            <th>Checkpoint</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for loan in loans %}
        <tr>
            <td><strong>{{ loan.card_number }}</strong></td>
            <td>{{ loan.borrower }}</td>
            <td>${{ loan.advanced_loan|floatformat:0|intcomma }}</td>
            <td>${{ loan.first_wired|floatformat:0|intcomma }}</td>
            <td>{% if loan.advanced_loan_invoice %}{{ loan.advanced_loan_invoice }}{% else %}—{% endif %}</td>
            <td>{{ loan.interest_rate_display }}%</td>
            <td>${{ loan.settlement|floatformat:0|intcomma }}</td>
            <td>
                {% if loan.checkpoint_valid %}
                    <span class="checkpoint-valid">✓ ${{ loan.checkpoint|floatformat:2|intcomma }}</span>
                {% else %}
                    <span class="checkpoint-invalid">✗ ${{ loan.checkpoint|floatformat:2|intcomma }}</span>
                {% endif %}
            </td>
            <td><span class="status-{{ loan.status_code }}">{{ loan.status_display_code }}</span></td>
            <td><a href="/api/loans/{{ loan.card_number }}/" class="btn">View</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<style>
    /* Search Dropdown Styles */
    .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #3498db;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        margin-top: -2px;
    }
    
    .search-result-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .search-result-item:hover,
    .search-result-item.selected {
        background: #f8f9fa;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .search-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .search-result-content {
        flex: 1;
    }
    
    .search-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
    }
    
    .search-result-title {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .search-result-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        color: white;
        font-weight: bold;
    }
    
    .badge-purple { background: #9b59b6; }
    .badge-blue { background: #3498db; }
    .badge-orange { background: #e67e22; }
    .badge-green { background: #27ae60; }
    .badge-gray { background: #95a5a6; }
    
    .search-result-context {
        font-size: 0.875rem;
        color: #666;
    }
    
    .search-no-results {
        padding: 1rem;
        text-align: center;
        color: #666;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #3498db;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .search-dropdown {
            max-height: 60vh;
        }
    }
</style>

<script>
(function() {
    const searchInput = document.getElementById('loan-search');
    const searchResults = document.getElementById('search-results');
    const searchLoading = document.getElementById('search-loading');
    
    let debounceTimer = null;
    let currentRequest = null;
    let selectedIndex = -1;
    let resultsData = [];
    
    // Debounced search function
    function performSearch() {
        const query = searchInput.value.trim();
        
        // Hide results if query is too short
        if (query.length < 2) {
            hideResults();
            return;
        }
        
        // Cancel previous request
        if (currentRequest) {
            currentRequest.abort();
        }
        
        // Show loading
        searchLoading.style.display = 'block';
        
        // Create new request
        currentRequest = new XMLHttpRequest();
        currentRequest.open('GET', '/api/loans/search/?q=' + encodeURIComponent(query), true);
        
        currentRequest.onload = function() {
            searchLoading.style.display = 'none';
            
            if (currentRequest.status === 200) {
                const data = JSON.parse(currentRequest.responseText);
                displayResults(data);
            }
        };
        
        currentRequest.onerror = function() {
            searchLoading.style.display = 'none';
            hideResults();
        };
        
        currentRequest.send();
    }
    
    // Display search results
    function displayResults(data) {
        resultsData = data.results || [];
        selectedIndex = -1;
        
        if (data.error) {
            searchResults.innerHTML = '<div class="search-no-results">' + data.error + '</div>';
            searchResults.style.display = 'block';
            return;
        }
        
        if (resultsData.length === 0) {
            searchResults.innerHTML = '<div class="search-no-results">No results found for "' + 
                                      escapeHtml(data.query) + '"</div>';
            searchResults.style.display = 'block';
            return;
        }
        
        let html = '';
        resultsData.forEach(function(result, index) {
            const badgeClass = 'badge-' + result.color;
            
            html += '<div class="search-result-item" data-index="' + index + '" data-url="' + result.detail_url + '">';
            html += '  <div class="search-icon">' + result.icon + '</div>';
            html += '  <div class="search-result-content">';
            html += '    <div class="search-result-header">';
            html += '      <div class="search-result-title">' + escapeHtml(result.card_number) + ' - ' + escapeHtml(result.borrower_name) + '</div>';
            html += '      <span class="search-result-badge ' + badgeClass + '">' + escapeHtml(result.match_type_display) + '</span>';
            html += '    </div>';
            html += '    <div class="search-result-context">' + escapeHtml(result.context);
            
            // Add invoice number if present
            if (result.invoice_number) {
                html += ' • Invoice: ' + escapeHtml(result.invoice_number);
            }
            
            html += '</div>';
            html += '  </div>';
            html += '</div>';
        });
        
        searchResults.innerHTML = html;
        searchResults.style.display = 'block';
        
        // Add click handlers
        const items = searchResults.querySelectorAll('.search-result-item');
        items.forEach(function(item) {
            item.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                window.location.href = url;
            });
        });
    }
    
    // Hide results
    function hideResults() {
        searchResults.style.display = 'none';
        searchResults.innerHTML = '';
        selectedIndex = -1;
        resultsData = [];
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Update selected item visual state
    function updateSelection() {
        const items = searchResults.querySelectorAll('.search-result-item');
        items.forEach(function(item, index) {
            if (index === selectedIndex) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    // Event: Input change
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(performSearch, 300);
    });
    
    // Event: Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        const items = searchResults.querySelectorAll('.search-result-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (selectedIndex < items.length - 1) {
                selectedIndex++;
                updateSelection();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (selectedIndex > 0) {
                selectedIndex--;
                updateSelection();
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                items[selectedIndex].click();
            }
        } else if (e.key === 'Escape') {
            hideResults();
            searchInput.blur();
        }
    });
    
    // Event: Click outside to close
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            hideResults();
        }
    });
    
    // Event: Focus to show results if query exists
    searchInput.addEventListener('focus', function() {
        if (searchInput.value.trim().length >= 2 && resultsData.length > 0) {
            searchResults.style.display = 'block';
        }
    });
})();
</script>

{% endblock %}
